{% extends "base.html" %}

{% block title %}{{ tenant_display_name }} - Add Referral{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-4">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="mb-4">
            <h1 class="text-2xl font-bold text-gray-800">Add New Referral</h1>
            <p class="text-gray-600 mt-2">Create a referral record for tracking your networking activities.</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="mb-4">
            {% for category, message in messages %}
            <div
                class="p-3 rounded-md {% if category == 'danger' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <form method="POST" action="{{ url_for('referrals.add_referral', tenant_id=tenant_id) }}" id="referralForm">
            <!-- Single Line Layout -->
            <div class="bg-gray-50 p-4 rounded-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-4">
                    <!-- Referral Type -->
                    <div>
                        <label for="referral_type_id" class="block text-gray-700 text-sm font-bold mb-2">Type:</label>
                        <select id="referral_type_id" name="referral_type_id" required
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                            <option value="">-- Select --</option>
                            {% for type in referral_types %}
                            <option value="{{ type.id }}" data-type-name="{{ type.type_name }}">
                                {{ type.type_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Field 1: Member/Contact Name/Prior Referral -->
                    <div id="field1" style="display: none;">
                        <label id="field1Label" class="block text-gray-700 text-sm font-bold mb-2">Member:</label>
                        <select id="referred_id" name="referred_id"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                            <option value="">-- Select Member --</option>
                            {% for user in all_users %}
                            <option value="{{ user.id }}">
                                {{ user.last_name or '' }}, {{ user.first_name or '' }}
                                {% if not user.first_name and not user.last_name %}{{ user.email }}{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <input type="text" id="referred_name" name="referred_name" style="display: none;"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm"
                            placeholder="Contact Name">
                        <select id="prior_referral_id" name="prior_referral_id" style="display: none;"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                            <option value="">-- Select Prior Referral --</option>
                            {% for referral in prior_referrals %}
                            <option value="{{ referral.id }}">
                                {{ referral.referred_name or (referral.referred_member.first_name + ' ' + referral.referred_member.last_name if referral.referred_member else 'Unknown') }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Field 2: Email/Value -->
                    <div id="field2" style="display: none;">
                        <label id="field2Label" class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                        <input type="email" id="contact_email" name="contact_email"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm"
                            placeholder="email@example.com">
                        <input type="number" id="referral_value" name="referral_value" step="0.01" min="0" style="display: none;"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm"
                            placeholder="0.00">
                    </div>

                    <!-- Field 3: Phone/Level -->
                    <div id="field3" style="display: none;">
                        <label id="field3Label" class="block text-gray-700 text-sm font-bold mb-2">Phone:</label>
                        <input type="tel" id="contact_phone" name="contact_phone"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm"
                            placeholder="(555) 123-4567">
                        <select id="referral_level" name="referral_level" style="display: none;"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                            <option value="">-- Level --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>

                    <!-- Field 4: Level (for Out of Group) -->
                    <div id="field4" style="display: none;">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Level:</label>
                        <select id="referral_level_2" name="referral_level_2"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                            <option value="">-- Select --</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>

                    <!-- Date -->
                    <div id="dateField" style="display: block;">
                        <label for="date_referred" class="block text-gray-700 text-sm font-bold mb-2">Date:</label>
                        <input type="date" id="date_referred" name="date_referred" required
                            value="{{ today.strftime('%Y-%m-%d') }}"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm">
                    </div>
                </div>

                <!-- Notes -->
                <div id="notesField" style="display: block;">
                    <label for="notes" class="block text-gray-700 text-sm font-bold mb-2">Notes:</label>
                    <textarea id="notes" name="notes" rows="2"
                        class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm"
                        placeholder="Additional notes..."></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-4">
                <a href="{{ url_for('referrals.my_referrals', tenant_id=tenant_id) }}"
                    class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-150">
                    Cancel
                </a>
                <button type="submit"
                    class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-150">
                    Add Referral
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const referralTypeSelect = document.getElementById('referral_type_id');
    const allFields = ['field1', 'field2', 'field3', 'field4', 'dateField', 'notesField'];

    // Initially show date and notes, hide others
    document.getElementById('dateField').style.display = 'block';
    document.getElementById('notesField').style.display = 'block';
    document.getElementById('field1').style.display = 'none';
    document.getElementById('field2').style.display = 'none';
    document.getElementById('field3').style.display = 'none';
    document.getElementById('field4').style.display = 'none';

    referralTypeSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const typeName = selectedOption.getAttribute('data-type-name');

        // Hide all fields first
        allFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.style.display = 'none';
        });

        // Hide all inputs
        const allInputs = ['referred_id', 'referred_name', 'prior_referral_id', 'contact_email', 'contact_phone', 'referral_level', 'referral_level_2', 'referral_value', 'date_referred', 'notes'];
        allInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.style.display = 'none';
                input.required = false;
            }
        });

        if (typeName === 'In Group') {
            // In Group: Group member dropdown, Level, Date, Notes
            document.getElementById('field1').style.display = 'block';
            document.getElementById('field1Label').textContent = 'Member:';
            document.getElementById('referred_id').style.display = 'block';
            document.getElementById('referred_id').required = true;

            document.getElementById('field3').style.display = 'block';
            document.getElementById('field3Label').textContent = 'Level:';
            document.getElementById('referral_level').style.display = 'block';
            document.getElementById('referral_level').required = true;

            document.getElementById('dateField').style.display = 'block';
            document.getElementById('notesField').style.display = 'block';

        } else if (typeName === 'Out of Group') {
            // Out of Group: Contact Name, email, Phone, Level, date, notes
            document.getElementById('field1').style.display = 'block';
            document.getElementById('field1Label').textContent = 'Name:';
            document.getElementById('referred_name').style.display = 'block';
            document.getElementById('referred_name').required = true;

            document.getElementById('field2').style.display = 'block';
            document.getElementById('field2Label').textContent = 'Email:';
            document.getElementById('contact_email').style.display = 'block';
            document.getElementById('contact_email').required = true;

            document.getElementById('field3').style.display = 'block';
            document.getElementById('field3Label').textContent = 'Phone:';
            document.getElementById('contact_phone').style.display = 'block';

            document.getElementById('field4').style.display = 'block';
            document.getElementById('referral_level_2').style.display = 'block';
            document.getElementById('referral_level_2').required = true;

            document.getElementById('dateField').style.display = 'block';
            document.getElementById('notesField').style.display = 'block';

        } else if (typeName === 'Subscription') {
            // Subscription: Prior Referral dropdown, value, date, notes
            document.getElementById('field1').style.display = 'block';
            document.getElementById('field1Label').textContent = 'Prior Referral:';
            document.getElementById('prior_referral_id').style.display = 'block';
            document.getElementById('prior_referral_id').required = true;

            document.getElementById('field2').style.display = 'block';
            document.getElementById('field2Label').textContent = 'Value:';
            document.getElementById('referral_value').style.display = 'block';

            document.getElementById('dateField').style.display = 'block';
            document.getElementById('notesField').style.display = 'block';
        }
    });

    // Form validation
    document.getElementById('referralForm').addEventListener('submit', function(e) {
        const selectedOption = referralTypeSelect.options[referralTypeSelect.selectedIndex];
        const typeName = selectedOption.getAttribute('data-type-name');

        if (typeName === 'In Group') {
            if (!document.getElementById('referred_id').value) {
                e.preventDefault();
                alert('Please select a member.');
                return false;
            }
            if (!document.getElementById('referral_level').value) {
                e.preventDefault();
                alert('Please select a level.');
                return false;
            }
        } else if (typeName === 'Out of Group') {
            if (!document.getElementById('referred_name').value) {
                e.preventDefault();
                alert('Please enter contact name.');
                return false;
            }
            if (!document.getElementById('contact_email').value) {
                e.preventDefault();
                alert('Please enter contact email.');
                return false;
            }
            if (!document.getElementById('referral_level_2').value) {
                e.preventDefault();
                alert('Please select a level.');
                return false;
            }
        } else if (typeName === 'Subscription') {
            if (!document.getElementById('prior_referral_id').value) {
                e.preventDefault();
                alert('Please select a prior referral.');
                return false;
            }
        }
    });
});
</script>
{% endblock %}
