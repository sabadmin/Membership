{% extends "base.html" %}

{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="container mx-auto p-4 mt-10">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Panel</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div
            class="p-3 rounded-md {% if category == 'danger' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Select Database and Table</h2>
        <form action="{{ url_for('admin.admin_panel') }}" method="GET"
            class="space-y-4 md:space-y-0 md:flex md:space-x-4 items-end">
            <div>
                <label for="selected_tenant_id" class="block text-gray-700 text-sm font-bold mb-2">Database:</label>
                <select id="selected_tenant_id" name="selected_tenant_id"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    {% for tid in all_tenant_ids %}
                    <option value="{{ tid }}" {% if tid==selected_tenant_id %}selected{% endif %}>
                        {{ Config.TENANT_DISPLAY_NAMES.get(tid, tid.capitalize()) }} ({{ tid }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="table" class="block text-gray-700 text-sm font-bold mb-2">Table:</label>
                <select id="table" name="table"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">-- Select Table --</option>
                    {% for tbl in tables %}
                    <option value="{{ tbl }}" {% if tbl==selected_table %}selected{% endif %}>{{ tbl }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Load
                Data</button>
        </form>
    </div>

    {% if selected_table and columns %}
    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Data for Table: {{ selected_table }} (Database: {{
            Config.TENANT_DISPLAY_NAMES.get(selected_tenant_id, selected_tenant_id.capitalize()) }})</h2>

        <table class="min-w-full divide-y divide-gray-200 border border-gray-300">
            <thead class="bg-gray-50">
                <tr>
                    {% for col in columns %}
                    <th scope="col"
                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">{{
                        col.name }}</th>
                    {% endfor %}
                    <th scope="col"
                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {# Add New Row Form #}
                <tr class="bg-blue-50">
                    <form
                        action="{{ url_for('admin.manage_data', selected_tenant_id=selected_tenant_id, table=selected_table) }}"
                        method="POST">
                        <input type="hidden" name="action" value="add">
                        {% for col in columns %}
                        <td class="px-3 py-2 whitespace-nowrap">
                            {% if col.name == primary_keys[selected_table][0] %}
                            {# Primary key is usually auto-increment, don't allow input #}
                            <span class="text-gray-400">AUTO</span>
                            {% elif col.name == 'password_hash' %}
                            <input type="password" name="new_{{ col.name }}" placeholder="New Password"
                                class="w-full border-gray-300 rounded-md text-sm">
                            {% else %}
                            <input type="text" name="new_{{ col.name }}" placeholder="{{ col.name }}"
                                class="w-full border-gray-300 rounded-md text-sm">
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="px-3 py-2 whitespace-nowrap">
                            <button type="submit" class="text-green-600 hover:text-green-900 text-sm">Add</button>
                        </td>
                    </form>
                </tr>

                {# Existing Data Rows #}
                {% for row in data %}
                <tr>
                    <form
                        action="{{ url_for('admin.manage_data', selected_tenant_id=selected_tenant_id, table=selected_table) }}"
                        method="POST">
                        <input type="hidden" name="action" value="edit">
                        <input type="hidden" name="id" value="{{ row[primary_keys[selected_table][0]] }}">
                        {% for col in columns %}
                        <td class="px-3 py-2 whitespace-nowrap">
                            {% if col.name == primary_keys[selected_table][0] %}
                            <span class="font-medium text-gray-900">{{ row[col.name] }}</span>
                            {% elif col.name == 'password_hash' %}
                            <span class="text-gray-500 text-sm">HASHED VALUE</span>
                            <label class="block mt-1 text-red-600 text-xs">
                                <input type="checkbox" name="edit_{{ col.name }}_delete" value="true"> Delete Hash
                            </label>
                            {% else %}
                            <input type="text" name="edit_{{ col.name }}" value="{{ row[col.name] or '' }}"
                                class="w-full border-gray-300 rounded-md text-sm">
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium">
                            <button type="submit" class="text-indigo-600 hover:text-indigo-900 mr-2">Update</button>
                            <button type="button"
                                onclick="confirmDelete('{{ selected_tenant_id }}', '{{ selected_table }}', '{{ row[primary_keys[selected_table][0]] }}')"
                                class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif selected_table %}
    <p class="text-center text-gray-600 mt-8">No data found for table '{{ selected_table }}'.</p>
    {% endif %}
</div>

<script>
    function confirmDelete(tenantId, tableName, rowId) {
        if (confirm(`Are you sure you want to delete row with ID ${rowId} from table ${tableName} in database ${tenantId}?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('admin.manage_data', selected_tenant_id=selected_tenant_id, table=selected_table) }}";

            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'delete';
            form.appendChild(actionInput);

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = rowId;
            form.appendChild(idInput);

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}