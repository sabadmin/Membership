{% extends "base.html" %}

{% block title %}Admin Panel{% endblock %}

{% block content %}
<div class="container mx-auto p-4 mt-10">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Admin Panel</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="mb-4">
        {% for category, message in messages %}
        <div
            class="p-3 rounded-md {% if category == 'danger' %}bg-red-100 text-red-700{% elif category == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Select Database and Table</h2>
        <form action="{{ url_for('admin.admin_panel', selected_tenant_id=selected_tenant_id) }}" method="POST"
            class="space-y-4 md:space-y-0 md:flex md:space-x-4 items-end">
            <div>
                <label for="tenant_to_manage" class="block text-gray-700 text-sm font-bold mb-2">Database:</label>
                <select id="tenant_to_manage" name="tenant_to_manage"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    {% for tid in all_tenant_ids %}
                    <option value="{{ tid }}" {% if tid==selected_tenant_id %}selected{% endif %}>
                        {{ Config.TENANT_DISPLAY_NAMES.get(tid, tid.capitalize()) }} ({{ tid }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="table_name" class="block text-gray-700 text-sm font-bold mb-2">Table:</label>
                <select id="table_name" name="table_name"
                    class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">-- Select Table --</option>
                    {% for tbl in tables %}
                    <option value="{{ tbl }}" {% if tbl==selected_table %}selected{% endif %}>{{ tbl }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit"
                class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Load
                Data</button>
        </form>
    </div>

    {% if selected_table and columns %}
    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Data for Table: {{ selected_table }} (Database: {{
            Config.TENANT_DISPLAY_NAMES.get(selected_tenant_id, selected_tenant_id.capitalize()) }})</h2>

        <style>
            .resizable-table {
                table-layout: fixed;
                width: 100%;
            }

            .resizable-col {
                resize: horizontal;
                overflow: auto;
                min-width: 100px;
                max-width: 400px;
            }
        </style>

        <table class="resizable-table divide-y divide-gray-200 border border-gray-300">
            <thead class="bg-gray-50">
                <tr>
                    {% for col in columns %}
                    <th scope="col"
                        class="resizable-col px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-300">
                        {% if col.startswith('can_edit_') %}
                        {{ col.replace('can_edit_', '').replace('_', ' ').title() }}
                        {% else %}
                        {{ col.replace('_', ' ').title() }}
                        {% endif %}
                    </th>
                    {% endfor %}
                    <th scope="col"
                        class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {# Add New Row Form #}
                <tr class="bg-blue-50">
                    <form action="{{ url_for('admin.admin_panel', selected_tenant_id=selected_tenant_id) }}"
                        method="POST">
                        <input type="hidden" name="action" value="add">
                        <input type="hidden" name="tenant_to_manage" value="{{ selected_tenant_id }}">
                        <input type="hidden" name="table_name" value="{{ selected_table }}">
                        {% for col in columns %}
                        <td class="px-3 py-2 whitespace-nowrap resize-x overflow-auto min-w-0">
                            {% if col == 'id' %}
                            {# Primary key is usually auto-increment, don't allow input #}
                            <span class="text-gray-400">AUTO</span>
                            {% elif col == 'password_hash' %}
                            <input type="password" name="{{ col }}" placeholder="New Password"
                                class="w-full border-gray-300 rounded-md text-sm resize-x">
                            {% elif col.startswith('can_edit_') %}
                            {# Boolean checkboxes for permission fields #}
                            <select name="{{ col }}" class="w-full border-gray-300 rounded-md text-sm">
                                <option value="false">No</option>
                                <option value="true">Yes</option>
                            </select>
                            {% elif col in ['user_id', 'referrer_id'] and selected_table in ['attendance_records',
                            'dues_records', 'referral_records'] %}
                            {# User selection dropdown for foreign key fields #}
                            <select name="{{ col }}" class="w-full border-gray-300 rounded-md text-sm" required>
                                <option value="">-- Select Member --</option>
                                {% for user_id, user_name in users_list %}
                                <option value="{{ user_id }}">{{ user_name }}</option>
                                {% endfor %}
                            </select>
                            {% elif col == 'dues_type_id' and selected_table == 'dues_records' %}
                            {# Dues type selection dropdown #}
                            <select name="{{ col }}" class="w-full border-gray-300 rounded-md text-sm" required>
                                <option value="">-- Select Dues Type --</option>
                                {% if dues_types_list %}
                                {% for type_id, type_name in dues_types_list %}
                                <option value="{{ type_id }}">{{ type_name }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                            {% elif 'date' in col.lower() %}
                            {# Date inputs for date fields #}
                            <input type="datetime-local" name="{{ col }}" placeholder="{{ col }}"
                                class="w-full border-gray-300 rounded-md text-sm resize-x">
                            {% else %}
                            <input type="text" name="{{ col }}" placeholder="{{ col }}"
                                class="w-full border-gray-300 rounded-md text-sm resize-x">
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="px-3 py-2 whitespace-nowrap">
                            <button type="submit" class="text-green-600 hover:text-green-900 text-sm">Add</button>
                        </td>
                    </form>
                </tr>

                {# Existing Data Rows #}
                {% for row in data %}
                <tr>
                    <form action="{{ url_for('admin.admin_panel', selected_tenant_id=selected_tenant_id) }}"
                        method="POST">
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="tenant_to_manage" value="{{ selected_tenant_id }}">
                        <input type="hidden" name="table_name" value="{{ selected_table }}">
                        <input type="hidden" name="id" value="{{ row.id }}">
                        {% for col in columns %}
                        <td class="px-3 py-2 whitespace-nowrap resize-x overflow-auto min-w-0">
                            {% if col == 'id' %}
                            <span class="font-medium text-gray-900">{{ row[col] }}</span>
                            {% elif col == 'password_hash' %}
                            <span class="text-gray-500 text-sm">HASHED VALUE</span>
                            {% elif col == 'user_id' and selected_table in ['attendance_records', 'dues_records'] %}
                            {# Editable dropdown for user_id in existing records #}
                            <select name="{{ col }}" class="w-full border-gray-300 rounded-md text-sm" required>
                                {% for user_id, user_name in users_list %}
                                <option value="{{ user_id }}" {% if user_id==row[col] %}selected{% endif %}>{{ user_name
                                    }}</option>
                                {% endfor %}
                            </select>
                            {% elif col == 'referrer_id' and selected_table == 'referral_records' %}
                            {# Editable dropdown for referrer_id in existing records #}
                            <select name="{{ col }}" class="w-full border-gray-300 rounded-md text-sm" required>
                                {% for user_id, user_name in users_list %}
                                <option value="{{ user_id }}" {% if user_id==row[col] %}selected{% endif %}>{{ user_name
                                    }}</option>
                                {% endfor %}
                            </select>
                            {% elif col == 'dues_type_id' and selected_table == 'dues_records' %}
                            {# Simple dropdown for dues_type with full names #}
                            <select name="{{ col }}" class="w-full border-gray-300 rounded-md text-sm" required>
                                {% for type_id, type_name in dues_types_list %}
                                <option value="{{ type_id }}" {% if type_id==row[col] %}selected{% endif %}>{{ type_name
                                    }}</option>
                                {% endfor %}
                            </select>
                            {% elif col.startswith('can_edit_') %}
                            {# Boolean dropdowns for permission fields #}
                            <select name="{{ col }}" class="w-full border-gray-300 rounded-md text-sm">
                                <option value="false" {% if not row[col] %}selected{% endif %}>No</option>
                                <option value="true" {% if row[col] %}selected{% endif %}>Yes</option>
                            </select>
                            {% elif 'date' in col.lower() %}
                            {# Date inputs for date fields #}
                            <input type="datetime-local" name="{{ col }}"
                                value="{% if row[col] %}{{ row[col].strftime('%Y-%m-%dT%H:%M') if row[col].__class__.__name__ == 'datetime' else row[col] }}{% endif %}"
                                class="w-full border-gray-300 rounded-md text-sm resize-x">
                            {% else %}
                            <input type="text" name="{{ col }}" value="{{ row[col] or '' }}"
                                class="w-full border-gray-300 rounded-md text-sm resize-x">
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium">
                            <button type="submit" class="text-indigo-600 hover:text-indigo-900 mr-2">Update</button>
                            <button type="button" onclick="confirmDelete('{{ row.id }}')"
                                class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    </form>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% elif selected_table %}
    <p class="text-center text-gray-600 mt-8">No data found for table '{{ selected_table }}'.</p>
    {% endif %}
</div>

<script>
    function confirmDelete(rowId) {
        if (confirm(`Are you sure you want to delete row with ID ${rowId}?`)) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = "{{ url_for('admin.admin_panel', selected_tenant_id=selected_tenant_id) }}";

            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'delete';
            form.appendChild(actionInput);

            const tenantInput = document.createElement('input');
            tenantInput.type = 'hidden';
            tenantInput.name = 'tenant_to_manage';
            tenantInput.value = '{{ selected_tenant_id }}';
            form.appendChild(tenantInput);

            const tableInput = document.createElement('input');
            tableInput.type = 'hidden';
            tableInput.name = 'table_name';
            tableInput.value = '{{ selected_table }}';
            form.appendChild(tableInput);

            const idInput = document.createElement('input');
            idInput.type = 'hidden';
            idInput.name = 'id';
            idInput.value = rowId;
            form.appendChild(idInput);

            document.body.appendChild(form);
            form.submit();
        }
    }
</script>
{% endblock %}