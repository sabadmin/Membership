{% extends "base.html" %}

{% block title %}{{ tenant_display_name }} Attendance - {{ 'Create' if editable else 'Review' }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 py-4">
    <div class="bg-white p-6 rounded-lg shadow-md">
        <div class="mb-4">
            <h1 class="text-2xl font-bold text-gray-800">{{ tenant_display_name }} Attendance - {{ 'Create' if editable
                else 'Review' }}</h1>
        </div>

        {% if editable %}
        <form method="POST" action="{{ url_for('members.attendance_create', tenant_id=tenant_id) }}"
            id="attendanceForm">
            {% endif %}
            <!-- Date and Event Selection -->
            <div class="mb-6 bg-gray-50 p-4 rounded-md">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="event_date" class="block text-gray-700 text-sm font-bold mb-2">Event Date:</label>
                        {% if editable %}
                        <input type="date" id="event_date" name="event_date" value="{{ today }}"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-blue-400"
                            required>
                        {% else %}
                        <input type="date" id="event_date" value="{{ today }}"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight bg-gray-100"
                            readonly>
                        {% endif %}
                    </div>
                    <div>
                        <label for="attendance_type_id" class="block text-gray-700 text-sm font-bold mb-2">Attendance Type:</label>
                        {% if editable %}
                        <select id="attendance_type_id" name="attendance_type_id"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-blue-400"
                            required>
                            <option value="">Select Attendance Type</option>
                            {% for attendance_type in attendance_types %}
                            <option value="{{ attendance_type.id }}">{{ attendance_type.type }} - {{ attendance_type.description }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <select id="attendance_type_id"
                            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight bg-gray-100"
                            disabled>
                            <option value="">Select Attendance Type</option>
                            {% for attendance_type in attendance_types %}
                            <option value="{{ attendance_type.id }}">{{ attendance_type.type }} - {{ attendance_type.description }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Attendance Matrix -->
            <div class="overflow-x-auto">
                <table class="min-w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            {% if editable %}
                            <th class="border border-gray-300 px-2 py-2 text-center text-sm font-bold text-gray-700">
                                <input type="checkbox" id="selectAll" onclick="toggleAllMembers()" 
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                                <br><span class="text-xs text-gray-500">Select</span>
                            </th>
                            {% endif %}
                            <th class="border border-gray-300 px-4 py-2 text-left text-sm font-bold text-gray-700">
                                Member Name</th>
                            <th class="border border-gray-300 px-3 py-2 text-center text-sm font-bold text-gray-700">
                                Present<br><span class="text-xs text-gray-500">(P)</span></th>
                            <th class="border border-gray-300 px-3 py-2 text-center text-sm font-bold text-gray-700">
                                Absent<br><span class="text-xs text-gray-500">(A)</span></th>
                            <th class="border border-gray-300 px-3 py-2 text-center text-sm font-bold text-gray-700">
                                Late<br><span class="text-xs text-gray-500">(L)</span></th>
                            <th class="border border-gray-300 px-3 py-2 text-center text-sm font-bold text-gray-700">
                                Excused<br><span class="text-xs text-gray-500">(E)</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in all_users %}
                        <tr data-user-id="{{ user.id }}"
                            class="{% if loop.index % 2 == 0 %}bg-gray-50{% else %}bg-white{% endif %} hover:bg-blue-50 transition duration-150">
                            {% if editable %}
                            <td class="border border-gray-300 px-2 py-2 text-center">
                                <input type="checkbox" id="select_{{ user.id }}" name="select_{{ user.id }}" class="member-select w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300" 
                                    onchange="updateSelectAllState()" checked>
                            </td>
                            {% endif %}
                            <td class="border border-gray-300 px-4 py-2 text-sm font-medium text-gray-900">
                                {{ user.first_name or '' }} {{ user.last_name or '' }}
                                {% if not user.first_name and not user.last_name %}
                                {{ user.email }}
                                {% endif %}
                                {% if user.user_role in ['attendance', 'president', 'admin'] %}
                                <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">{{
                                    user.user_role.title() }}</span>
                                {% endif %}
                            </td>
                            <td class="border border-gray-300 px-3 py-2 text-center">
                                <input type="radio" id="present_{{ user.id }}" name="attendance_{{ user.id }}" value="P"
                                    {% if existing_attendance.get(user.id)=='P' %}checked{% endif %} {% if not editable
                                    %}disabled{% endif %}
                                    class="w-4 h-4 text-green-600 focus:ring-green-500 border-gray-300">
                            </td>
                            <td class="border border-gray-300 px-3 py-2 text-center">
                                <input type="radio" id="absent_{{ user.id }}" name="attendance_{{ user.id }}" value="A"
                                    {% if existing_attendance.get(user.id)=='A' %}checked{% endif %} {% if not editable
                                    %}disabled{% endif %}
                                    class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300">
                            </td>
                            <td class="border border-gray-300 px-3 py-2 text-center">
                                <input type="radio" id="late_{{ user.id }}" name="attendance_{{ user.id }}" value="L" {%
                                    if existing_attendance.get(user.id)=='L' %}checked{% endif %} {% if not editable
                                    %}disabled{% endif %}
                                    class="w-4 h-4 text-yellow-600 focus:ring-yellow-500 border-gray-300">
                            </td>
                            <td class="border border-gray-300 px-3 py-2 text-center">
                                <input type="radio" id="excused_{{ user.id }}" name="attendance_{{ user.id }}" value="E"
                                    {% if existing_attendance.get(user.id)=='E' %}checked{% endif %} {% if not editable
                                    %}disabled{% endif %}
                                    class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if editable %}
            <!-- Action Buttons for Create Mode -->
            <div class="mt-6 flex justify-between items-center">
                <div class="text-sm text-gray-600">
                    <span id="checkedCount">0</span> of {{ all_users|length }} members marked
                </div>
                <div class="space-x-2">
                    <button type="button" onclick="markAllPresent()"
                        class="bg-green-500 hover:bg-green-700 text-white px-4 py-2 rounded text-sm transition duration-150">
                        Mark All Present
                    </button>
                    <button type="submit"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold px-6 py-2 rounded focus:outline-none focus:shadow-outline transition duration-150">
                        Save Attendance
                    </button>
                </div>
            </div>
            {% else %}
            <!-- Info for Review Mode -->
            <div class="mt-6 text-center">
                <div class="text-sm text-gray-600 mb-4">
                    Viewing attendance in read-only mode. Contact an attendance officer or president to make changes.
                </div>
                <div class="text-sm text-gray-600">
                    Marked: <span id="checkedCount">0</span> of {{ all_users|length }} members
                </div>
            </div>
            {% endif %}
            {% if editable %}
        </form>
        {% endif %}
    </div>
</div>

{% if editable %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Update counter when radio buttons change
        updateCheckedCount();

        // Add event listeners to all radio buttons
        const radioButtons = document.querySelectorAll('input[type="radio"]');
        radioButtons.forEach(radio => {
            radio.addEventListener('change', updateCheckedCount);
        });
    });

    function toggleAllMembers() {
        const selectAll = document.getElementById('selectAll');
        const memberSelects = document.querySelectorAll('.member-select');
        
        memberSelects.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateCheckedCount();
    }

    function updateSelectAllState() {
        const memberSelects = document.querySelectorAll('.member-select');
        const selectAll = document.getElementById('selectAll');
        const checkedCount = document.querySelectorAll('.member-select:checked').length;
        
        selectAll.checked = checkedCount === memberSelects.length;
        selectAll.indeterminate = checkedCount > 0 && checkedCount < memberSelects.length;
        
        updateCheckedCount();
    }

    function updateCheckedCount() {
        let checkedUsers = 0;
        const selectedMembers = document.querySelectorAll('.member-select:checked').length;
        const totalUsers = document.querySelectorAll('tr[data-user-id]').length;

        // Count users with checked radio buttons among selected members
        document.querySelectorAll('tr[data-user-id]').forEach(row => {
            const userId = row.getAttribute('data-user-id');
            const memberSelect = document.querySelector('#select_' + userId);
            const checkedRadio = document.querySelector('input[name="attendance_' + userId + '"]:checked');
            
            if (memberSelect && memberSelect.checked && checkedRadio) {
                checkedUsers++;
            }
        });

        document.getElementById('checkedCount').textContent = checkedUsers + ' of ' + selectedMembers + ' selected';

        // Change color based on completion
        const counter = document.getElementById('checkedCount');
        if (checkedUsers === selectedMembers && selectedMembers > 0) {
            counter.className = 'text-green-600 font-bold';
        } else if (checkedUsers > 0) {
            counter.className = 'text-yellow-600 font-bold';
        } else {
            counter.className = 'text-red-600 font-bold';
        }
    }

    function markAllPresent() {
        // Only mark selected members as present
        document.querySelectorAll('.member-select:checked').forEach(checkbox => {
            const userId = checkbox.id.replace('select_', '');
            const presentRadio = document.querySelector('#present_' + userId);
            if (presentRadio) {
                presentRadio.checked = true;
            }
        });
        updateCheckedCount();
    }

    // Updated validation before form submission - only require selected members to have attendance
    document.getElementById('attendanceForm').addEventListener('submit', function (e) {
        let checkedUsers = 0;
        let selectedMembers = 0;

        // Count selected members and their attendance status
        document.querySelectorAll('tr[data-user-id]').forEach(row => {
            const userId = row.getAttribute('data-user-id');
            const memberSelect = document.querySelector('#select_' + userId);
            
            if (memberSelect && memberSelect.checked) {
                selectedMembers++;
                const checkedRadio = document.querySelector('input[name="attendance_' + userId + '"]:checked');
                if (checkedRadio) {
                    checkedUsers++;
                }
            }
        });

        if (selectedMembers === 0) {
            e.preventDefault();
            showToast('Please select at least one member for attendance.', 'error');
            return false;
        }

        if (checkedUsers < selectedMembers) {
            e.preventDefault();
            showToast('Please mark attendance for all ' + selectedMembers + ' selected members. Currently ' + checkedUsers + ' marked.', 'warning');
            return false;
        }
    });
</script>
{% else %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Count already marked attendance for review mode
        let checkedUsers = 0;
        const totalUsers = document.querySelectorAll('tr[data-user-id]').length;

        document.querySelectorAll('tr[data-user-id]').forEach(row => {
            const userId = row.getAttribute('data-user-id');
            const checkedRadio = document.querySelector('input[name="attendance_' + userId + '"]:checked');
            if (checkedRadio) {
                checkedUsers++;
            }
        });

        document.getElementById('checkedCount').textContent = checkedUsers;
    });
</script>
{% endif %}
{% endblock %}
